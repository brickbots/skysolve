<!doctype html>
<html lang="en">

<head>
    <title>Sky Solve</title>
    <link rel="stylesheet" href="../static/styles/bootstrap.min.css">
    <script src="/static/js/jquery_3.5.1.min.js"></script>
    <script src="/static/js/popper.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <style>
        body {
            background-color: rgba(114, 106, 109, 0.952);
        }
        
        .btn-primary,
        .btn-primary:hover,
        .btn-primary:active,
        .btn-primary:visited {
            background-color: #e02020 !important;
        }
        
        .btn-primary:hover {
            background-color: #f54e4eb9 !important;
        }
        
        .slidecontainer {
            width: 100%;
        }
        
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 15px;
            border-radius: 5px;
            background: #6e0303;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }
        
        .slider:hover {
            opacity: 1;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #f82727;
            cursor: pointer;
        }
        
        .slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
    </style>

    <style>
        * {
            box-sizing: border-box;
        }
        
        .img-magnifier-container {
            position: relative;
        }
        
        .img-magnifier-glass {
            position: absolute;
            border: 3px solid #000;
            border-radius: 50%;
            cursor: none;
            /*Set the size of the magnifier glass:*/
            width: 200px;
            height: 200px;
        }
    </style>


    <style>
        #myProgress {
            width: 100%;
            background-color: #ddd;
        }
        
        #myBar {
            width: 1%;
            height: 30px;
            text-align: center;
            background-color: #cf440c;
        }
    </style>

    <!--    toggle switch -->
    <style>
        .switchT {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 24px;
        }
        
        .switchT input {
            opacity: 50;
            width: 0;
            height: 0;
        }
        
        .sliderT {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgb(134, 19, 19);
            -webkit-transition: .4s;
            transition: .4s;
        }
        
        .sliderT:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: rgb(241, 65, 65);
            -webkit-transition: .4s;
            transition: .4s;
        }
        
        input:checked+.sliderT {
            background-color: #f0a9a9;
        }
        
        input:focus+.sliderT {
            box-shadow: 0 0 1px #2196F3;
        }
        
        input:checked+.sliderT:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }
        /* Rounded sliders */
        
        .sliderT.round {
            border-radius: 34px;
        }
        
        .sliderT.round:before {
            border-radius: 50%;
        }

    
        /* The Modal (background) */

        .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        /* Modal Content/Box */
        .modal-content {
        background-color: #fefefe;
        margin: 15% auto; /* 15% from the top and centered */
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* Could be more or less, depending on screen size */
        }

        /* The Close Button */
        .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        }

        .close:hover,
        .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
        }
    </style>

    <body>
      
        <div class="container-fluid">
            <div class="row">
                <div class="col">
                    <button class="btn btn-primary" onclick="ajax_get_Status('/pause')">Pause</button>

                    <button type="button" class="btn btn-primary text-dark" onclick="ajax_get_Status('/Align')">Align</button>

                    <button type="button" class="btn btn-primary" onclick="ajax_get_Status('/Solve')">Solve</button>
                    <button type="button" class="btn btn-primary" id = "testMode" >Test</button>
                    <button type="button" class="btn btn-primary" style="display: none;" id="stepPrev">Previous Image</button>
                    <button type="button" class="btn btn-primary" style="display: none;" id="stepNext">Next Image</button>
                    <button type="button" class="btn btn-primary" style="display: none;" id="retryNext">Retry</button>
                    <button type="button" class="btn btn-primary" style="display: none;" id="solveThis">Solve This one</button>
                   
                    <button type="button" class="btn btn-primary" data-toggle="collapse" data-target="#skyConfig">sky cfg</button>
                    <button type="button" class="btn btn-primary" data-toggle="collapse" data-target="#solveCfg">solve cfg</button>

                </div>
            </div>

            <div class="row">
                <div class="col mx-2">
                    <label class="form-check-label">
                      <input  type="checkbox" id="autoStatusCB" checked="checked"  class=" pl-5 form-check-input" 
                        onclick="updateStatusField() ; checked">Auto Status
                    </label>
                </div>
                <div id="statusField" class="col-10 bg-danger">
                    <p></p>
                </div>
            </div>


        </div>


        <div id="skyConfig" class="collapse">
            <div class="btn-group" role="group" aria-label="b">
                <label class=" text-warning " for="shutter">Shutter Speed:</label>
                <select class=" form-control-sm text-warning bg-dark"  id="shutterSelect">
                    {% for datum in shutterData %}
                  <option class="bg_dark text-warning" value={{ datum }}>{{ datum }}</option> 
                   {% endfor %}

                </select> 

                <div class="dropdown">
                    <button type="button" class="btn btn-lg text-warning dropdown-toggle" id="ISOButton" data-toggle="dropdown">
                    ISO
                    </button>

                    <div class="dropdown-menu bg-dark" aria-labelledby="dropdownMenuButton" id="ISOMenu">
                        {% for datum in skyIsoData %}
                        <button class="dropdown-item text-warning bg-danger" type="button">{{ datum }}</button> {% endfor %}
                    </div>
                </div>
                <div class="dropdown">
                    <button type="button" class="btn btn-lg text-warning dropdown-toggle" data-toggle="dropdown">
                    image Size
                    </button>

                    <div class="dropdown-menu bg-dark" aria-labelledby="dropdownMenuButton">
                        {% for datum in skyFrameData %}
                        <button class="dropdown-item text-warning bg-danger" type="button">{{ datum }}</button> {% endfor %}
                    </div>
                </div>

                <div class="pt-3">
                    focus
                    <label class="switchT">
                        <input type="checkbox" id="doFocus" data-toggle="collapse" data-target="#collapseFocusBar" onclick="showFocus()">
                        <span class="sliderT round"></span>
                      </label>
                </div>
                <!--
                <label for="doMagCB">Magnify</label>
                <input type="checkbox" id="doMagCB" onclick="doMag()">
                -->

                <div class="btn-group-vertical  bg-danger ">
                    <button type="button" class="btn btn-primary btn-sm" onclick="increaseMagnification()">+</button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="decreaseMagnification()">-</button>
                </div>

            </div>
        </div>

        <!-- Trigger/Open The Modal -->
<button id="myBtn">Solver Configuration</button>

<!-- The Modal -->
<div id="myModal" class="modal">

  <!-- Modal content -->
  <div class="modal-content">
    <span class="close">&times;</span>
    <form action="/action_page.php">
        <p>Field size estimate:</p>
        <input type="radio" id="aPP" name="Arc Seconds per Pixel" value="aPP">
        <label for="aPP">Arc Seconds per Pixel</label>   <input type="number" name="faPP" value="27"><br><br>
        <input type="radio" id="FW" name="FW" value="FieldWidthDeg">
        <label for="FW">Field Width Degrees</label><br>
        <input type="radio" id="other" name="gender" value="other">
        <label for="other">Other</label>
      
        <br>  
      
        <p>Please select your age:</p>
        <input type="radio" id="age1" name="age" value="30">
        <label for="age1">0 - 30</label><br>
        <input type="radio" id="age2" name="age" value="60">
        <label for="age2">31 - 60</label><br>  
        <input type="radio" id="age3" name="age" value="100">
        <label for="age3">61 - 100</label><br><br>
        <input type="submit" value="Submit">
      </form>
    <p>Some text in the Modal..</p>
  </div>

</div>
        <div id="solveCfg" class="collapse">
            <form action="/applySolve" method="POST">
                <label for="App">Arcseconds per Pixel:</label>
                <input type="number" class="bg-danger" id="App" name="App" min="1" max="300" value="27">
                <label for="timeout">Max Time:"</label>
                <input type="number" class- "bg-danger" id="timeout" , name="timeout" , min="30" value="30">
                <input type="submit" name="save" class="btn btn-primary">Save</input>
                <input type="submit" name="Apply" class="btn btn-primary">Apply</input>
                <button type="button" class="btn btn-primary" data-toggle="collapse" data-target="#solveHistory">History</button>

            </form>
        </div>
"
        <div id="solveHistory" class="collapse">
            <button type="button" class="btn-primary" id="ClearHistory" >Clear History</button>
            <label class="form-check-label">
            <input type="checkbox" id="showSolveHistory" checked="checked" 
             > Show Solve History</label>

            <label class="form-check-label">
            <input  type="checkbox" id="showSolutionCB" 
             > Show Solution
             </label>
       </div>

 
        <p id="demo"></p>


        <div class="collapse" id="collapseFocusBar">
            <div id="myProgress"></div>
            <div id="myBar"></div>
        </div>
        </div>
        <div class="img-magnifier-container" style="overflow: scroll;">
            <img src="{{ url_for('video_feed') }}" id="skyImage" style="width:95%"></a>

        </div>
  
        <div style="overflow-y: scroll; height: 300px; color:rgb(247, 130, 130); background:rgb(26, 2, 9);"  id="solveStatusText">
              initialiing camera Waiting for first Image </div>

              <img src="/static/cap.jpg?Dummy=1234 /" alt="Girl in a jacket" width="500" height="600">
        <!-- SCRIPTS  -------------------------------------------->

        <script>
// Get the modal
var modal = document.getElementById("myModal");

// Get the button that opens the modal
var btn = document.getElementById("myBtn");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];

// When the user clicks on the button, open the modal
btn.onclick = function() {
  modal.style.display = "block";
}

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
  modal.style.display = "none";
}

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
  if (event.target == modal) {
    modal.style.display = "none";
  }
}
            var output = document.getElementById('solveStatusText');
        
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/solveLog');
            xhr.send();
            var position = 0;
        
            function handleNewData() {
                // the response text include the entire response so far
                // split the messages, then take the messages that haven't been handled yet
                // position tracks how many messages have been handled
                // messages end with a newline, so split will always show one extra empty message at the end
                var messages = xhr.responseText.split('\n');
                messages.slice(position, -1).forEach(function(value) {

                    // build and append a new item to a list to log all output
                    //value = "<br>" + value;
                    output.innerHTML += ('<br>' + value);
                    var element = document.getElementById("solveStatusText");
                    element.scrollTop = element.scrollHeight;
                });
                position = messages.length - 1;
            }
        
            var timer;
            timer = setInterval(function() {
                // check the response for new dat
                handleNewData();
                // stop checking once the response has ended
                if (xhr.readyState == XMLHttpRequest.DONE) {
                    clearInterval(timer);
                }
            }, 500);
        </script>

        <script>
            $("#ISOMenu>button ").click(function() {
                let x = $(this).text();
                $("#ISOButton").html(x)
                $.post("/setISO/" + x, data = {
                    suggest: x
                }, function(result) {

                });
            });
        </script>
        <script>
            function ajax_get_Status(cmdroute) {
                console.log('fun', cmdroute)
                $.ajax({
                    url: cmdroute,
                    method: 'POST',
                    success: function(result) {
                        document.getElementById("statusField").innerHTML = result;
                    }
                });
            }



    </script>


        <!-- Update status and clear timeout if needed-->
        <script>
            function updateStatusField() {
                console.log("updateStatusField called ")
                $.ajax({
                    url: '/skyStatus',
                    type: 'post',
                    success: function(data) {
                            // Perform operation on return value
                        var st = document.getElementById("statusField");
                        st.innerHTML = data
                    },
                    complete: function(data) {

                        var checkBox = document.getElementById("autoStatusCB");
                        if (checkBox.checked == true) {
                            setTimeout(updateStatusField, 5000);
                        } else {
                            clearTimeout(updateStatusField);
                        }
                    }
                });


            }
        </script>


        <script>
            $(function() {
                //window.setInterval('updateLog() ', 5000);
            });

            function updateLog() {
                $.get('/log', function(data, status) {
                    $('#solveLog').append('<br>' + data);
                });
            }
        </script>



        <script>
            var intervalID;

            function showFocus() {
                var f = document.getElementById("doFocus")
                if (f.checked == true) {
                    intervalID = setInterval(updateFocus, 500);
                    console.log('setup focus');
                } else {
                    console.log('clear focus');
                    clearInterval(intervalID);
                };

                function updateFocus() {
                    var elem = document.getElementById("myBar");
                    $.ajax({
                        url: '/Focus',
                        method: 'POST',
                        success: function(result) {
                            var width = parseInt(result)
                            while (width < 50) {
                                width *= 2;
                            }
                            elem.style.width = width + "%";
                            elem.innerHTML = result;

                        }
                    });
                }
            }
        </script>


        <script>
            var skyimageMag = 1;


            function increaseMagnification() {
                skyimageMag = skyimageMag * 1.5;
                var zoom = skyimageMag
                var sky = document.getElementById("skyImage");
                sky.style.width = (100 * zoom) + "%";
                sky.style.height = (100 * zoom) + "%";
                console.log(" mag", zoom, sky.style.width)

            }

            function decreaseMagnification() {
                skyimageMag = skyimageMag / 1.5;
                if (skyimageMag < .1) {
                    skyimageMag = 1.;
                }
                var zoom = skyimageMag
                var sky = document.getElementById("skyImage");
                sky.style.width = (100 * zoom) + "%";
                sky.style.height = (100 * zoom) + "%";
                console.log(" mag", zoom, sky.style.width)
            }
        </script>
        <script src= '../static/js/skySolve.js'></script>

    </body>

</html>